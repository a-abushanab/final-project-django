{% extends 'base.html' %}
{% load book_extras %}
{% block title %}Borrowing History â€” E-Library{% endblock %}

{% block extra_css %}
<style>
  .history-hero {
    background: linear-gradient(135deg, #1a237e 0%, #283593 60%, #0d47a1 100%);
    color: #fff;
    padding: 2.5rem 0 2rem;
  }
  .filter-tabs .nav-link {
    border-radius: 20px; padding: .35rem 1.1rem;
    font-size: .85rem; font-weight: 500; color: #5c6bc0;
    border: 1px solid transparent;
  }
  .filter-tabs .nav-link.active {
    background: #e8eaf6; border-color: #c5cae9; color: #1a237e; font-weight: 700;
  }
  .filter-tabs .nav-link:hover:not(.active) { background: #f3f4ff; }
  .record-card {
    border-radius: 12px; border: 1px solid #e8eaf6;
    transition: box-shadow .2s;
  }
  .record-card:hover { box-shadow: 0 4px 18px rgba(0,0,0,.08); }
  .status-badge-borrowed { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }
  .status-badge-returned { background: #d1e7dd; color: #0f5132; border: 1px solid #a3cfbb; }
  .status-badge-overdue  { background: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
  .cover-thumb {
    width: 50px; height: 72px; object-fit: cover;
    border-radius: 6px; flex-shrink: 0;
  }
  .cover-placeholder {
    width: 50px; height: 72px; border-radius: 6px; flex-shrink: 0;
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    display: flex; align-items: center; justify-content: center;
  }
</style>
{% endblock %}

{% block pre_content %}
<div class="history-hero">
  <div class="container">
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb mb-0" style="--bs-breadcrumb-divider-color:rgba(255,255,255,.5);">
        <li class="breadcrumb-item">
          <a href="{% url 'home' %}" style="color:rgba(255,255,255,.75);text-decoration:none;">Home</a>
        </li>
        <li class="breadcrumb-item active" style="color:rgba(255,255,255,.9);">Borrowing History</li>
      </ol>
    </nav>
    <div class="d-flex align-items-center gap-3">
      <div style="width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;font-size:1.6rem;">
        <i class="bi bi-clock-history"></i>
      </div>
      <div>
        <h1 style="font-size:1.8rem;font-weight:800;margin-bottom:.3rem;">Borrowing History</h1>
        <div class="d-flex gap-3" style="font-size:.85rem;opacity:.85;">
          <span><i class="bi bi-list-check me-1"></i>{{ records|length }} record{{ records|length|pluralize }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
{% if records %}

<div class="d-flex flex-wrap gap-2 align-items-center mb-4">
  <ul class="nav filter-tabs flex-wrap gap-1 mb-0">
    <li class="nav-item">
      <a class="nav-link {% if not request.GET.status %}active{% endif %}"
         href="{% url 'my_borrowings' %}">All ({{ records|length }})</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if request.GET.status == 'borrowed' %}active{% endif %}"
         href="{% url 'my_borrowings' %}?status=borrowed">
        <i class="bi bi-book me-1"></i>Active
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if request.GET.status == 'returned' %}active{% endif %}"
         href="{% url 'my_borrowings' %}?status=returned">
        <i class="bi bi-check2-circle me-1"></i>Returned
      </a>
    </li>
  </ul>
  <a href="{% url 'my_books' %}" class="btn btn-outline-primary btn-sm ms-auto" style="border-radius:20px;">
    <i class="bi bi-book-fill me-1"></i>Active Borrows
  </a>
</div>

<div class="d-flex flex-column gap-3">
  {% for record in records %}
  <div class="card record-card shadow-sm">
    <div class="card-body p-3">
      <div class="d-flex gap-3 align-items-start">

        <a href="{% url 'book_detail' record.book.pk %}">
          {% if record.book.cover_image %}
          <img src="{{ record.book.cover_image.url }}" alt="{{ record.book.title }}" class="cover-thumb">
          {% else %}
          <div class="cover-placeholder">
            <i class="bi bi-book" style="font-size:1.2rem;color:#90b4e8;opacity:.7;"></i>
          </div>
          {% endif %}
        </a>

        <div class="flex-grow-1 min-w-0">
          <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
            <div>
              <a href="{% url 'book_detail' record.book.pk %}"
                 class="fw-bold text-dark text-decoration-none"
                 style="font-size:.95rem;line-height:1.3;">
                {{ record.book.title }}
              </a>
              {% if record.book.author %}
              <p class="text-muted mb-0" style="font-size:.8rem;">{{ record.book.author.name }}</p>
              {% endif %}
            </div>

            {% if record.is_overdue %}
            <span class="badge status-badge-overdue px-2 py-1" style="border-radius:20px;font-size:.75rem;">
              <i class="bi bi-exclamation-triangle-fill me-1"></i>Overdue
            </span>
            {% elif record.status == 'borrowed' %}
            <span class="badge status-badge-borrowed px-2 py-1" style="border-radius:20px;font-size:.75rem;">
              <i class="bi bi-clock me-1"></i>Borrowed
            </span>
            {% else %}
            <span class="badge status-badge-returned px-2 py-1" style="border-radius:20px;font-size:.75rem;">
              <i class="bi bi-check-circle-fill me-1"></i>Returned
            </span>
            {% endif %}
          </div>

          <div class="d-flex flex-wrap gap-3 mt-2" style="font-size:.78rem;color:#555;">
            <span><i class="bi bi-calendar3 me-1 text-muted"></i>Borrowed: <strong>{{ record.borrow_date|date:"M d, Y" }}</strong></span>
            <span><i class="bi bi-calendar-check me-1 text-muted"></i>Due: <strong>{{ record.due_date|date:"M d, Y" }}</strong></span>
            {% if record.return_date %}
            <span><i class="bi bi-arrow-return-left me-1 text-muted"></i>Returned: <strong>{{ record.return_date|date:"M d, Y" }}</strong></span>
            {% elif record.days_remaining is not None %}
              {% with days=record.days_remaining %}
              {% if days < 0 %}
              <span style="color:#dc3545;font-weight:600;"><i class="bi bi-exclamation-circle-fill me-1"></i>Late by {{ days|abs }} day{{ days|abs|pluralize }}</span>
              {% elif days == 0 %}
              <span style="color:#e65100;font-weight:600;"><i class="bi bi-alarm me-1"></i>Due today!</span>
              {% else %}
              <span style="color:#2e7d32;font-weight:600;"><i class="bi bi-hourglass-split me-1"></i>{{ days }} day{{ days|pluralize }} left</span>
              {% endif %}
              {% endwith %}
            {% endif %}
          </div>

          {% if record.status == 'borrowed' %}
          <div class="mt-2">
            <form method="post" action="{% url 'return_book' record.pk %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-danger"
                      style="border-radius:8px;font-size:.78rem;"
                      onclick="return confirm('Return \'{{ record.book.title|escapejs }}\'?')">
                <i class="bi bi-arrow-return-left me-1"></i>Return Book
              </button>
            </form>
          </div>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% else %}
<div class="text-center text-muted py-5 bg-white rounded-3 border" style="border-style:dashed!important;">
  <i class="bi bi-clock-history" style="font-size:3rem;opacity:.3;"></i>
  <p class="mt-2 mb-1 fw-semibold">No borrowing history</p>
  <p class="small mb-3">You haven't borrowed any books yet. Browse the library and start reading!</p>
  <a href="{% url 'book_list' %}" class="btn btn-primary btn-sm" style="border-radius:8px;">
    <i class="bi bi-journals me-1"></i>Browse Books
  </a>
</div>
{% endif %}
{% endblock %}
