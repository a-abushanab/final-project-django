{% extends 'base.html' %}
{% load book_extras %}
{% block title %}All Books — E-Library{% endblock %}

{% block extra_css %}
<style>
  /* ── Toolbar ── */
  .books-toolbar {
    background: #fff;
    border: 1px solid #e3e8f0;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,.05);
  }
  .search-input {
    font-size: .95rem;
  }

  /* ── Cards ── */
  .book-card {
    border-radius: 12px;
    overflow: hidden;
    transition: transform .2s ease, box-shadow .2s ease;
    border: 1px solid #eaecf0 !important;
  }
  .book-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 32px rgba(0,0,0,.13) !important;
  }
  .book-cover-wrap {
    position: relative;
    height: 220px;
    overflow: hidden;
    background: linear-gradient(135deg, #e8f0fe, #c5d8fd);
  }
  .book-cover-wrap img {
    width: 100%; height: 100%; object-fit: cover;
    transition: transform .3s ease;
  }
  .book-card:hover .book-cover-wrap img { transform: scale(1.04); }
  .book-cover-ph {
    width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
  }
  .status-ribbon {
    position: absolute;
    top: 10px; right: 10px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: .72rem;
    font-weight: 700;
    letter-spacing: .4px;
  }
  .ribbon-available   { background: #d4edda; color: #155724; }
  .ribbon-unavailable { background: #f8d7da; color: #721c24; }

  .book-card .card-body { padding: 1rem; }
  .book-title {
    font-size: .92rem;
    font-weight: 700;
    line-height: 1.35;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    min-height: 2.5em;
  }
  .book-author { font-size: .8rem; color: #6c757d; }
  .stars-sm { color: #ffc107; font-size: .78rem; letter-spacing: .5px; }
  .no-rating { font-size: .78rem; color: #adb5bd; }

  .btn-details {
    font-size: .82rem;
    border-radius: 8px;
    padding: .4rem .9rem;
    font-weight: 600;
  }

  /* ── Active filters pills ── */
  .filter-pill {
    background: #e9f0ff;
    color: #0d47a1;
    border-radius: 20px;
    padding: 3px 12px;
    font-size: .8rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  /* ── Pagination ── */
  .pagination .page-link {
    border-radius: 8px !important;
    margin: 0 2px;
    font-weight: 600;
    color: #0d6efd;
    border-color: #dee2e6;
  }
  .pagination .page-item.active .page-link {
    background: #0d6efd; border-color: #0d6efd;
  }

  /* ── Empty state ── */
  .empty-state {
    background: #fff; border-radius: 16px;
    border: 2px dashed #dee2e6;
    padding: 4rem 2rem;
  }
</style>
{% endblock %}


{% block content %}

<!-- PAGE HEADER -->
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h2 class="fw-bold mb-0" style="font-size:1.6rem;">
      <i class="bi bi-journals me-2 text-primary"></i>All Books
    </h2>
    <div style="width:44px;height:4px;background:#0d6efd;border-radius:3px;margin-top:6px;"></div>
  </div>
  {% if user.is_staff %}
  <a href="{% url 'book_create' %}" class="btn btn-success">
    <i class="bi bi-plus-circle me-1"></i>Add Book
  </a>
  {% endif %}
</div>

<!-- TOOLBAR: search + category + sort -->
<div class="books-toolbar">
  <form method="get" id="filter-form">
    <div class="row g-2 align-items-center">

      <!-- Search -->
      <div class="col-12 col-md-6">
        <div class="input-group">
          <span class="input-group-text bg-white border-end-0">
            <i class="bi bi-search text-muted"></i>
          </span>
          <input type="text" name="q" value="{{ query }}"
                 class="form-control border-start-0 search-input"
                 placeholder="Search by title or author...">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>

      <!-- Category dropdown -->
      <div class="col-6 col-md-3">
        <select name="category" class="form-select" onchange="this.form.submit()">
          <option value="">All Categories</option>
          {% for cat in categories %}
          <option value="{{ cat.pk }}" {% if selected_category == cat.pk|stringformat:'s' %}selected{% endif %}>
            {{ cat.name }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- Sort dropdown -->
      <div class="col-6 col-md-3">
        <select name="sort" class="form-select" onchange="this.form.submit()">
          <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest First</option>
          <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>Oldest First</option>
          <option value="rating" {% if sort == 'rating' %}selected{% endif %}>Highest Rated</option>
        </select>
      </div>

    </div>
  </form>
</div>

<!-- ACTIVE FILTERS + RESULT COUNT -->
<div class="d-flex flex-wrap align-items-center gap-2 mb-3">
  <span class="text-muted" style="font-size:.88rem;">
    <strong>{{ total_count }}</strong> book{{ total_count|pluralize }} found
  </span>
  {% if query %}
  <span class="filter-pill">
    <i class="bi bi-search"></i> "{{ query }}"
    <a href="?{% if selected_category %}category={{ selected_category }}&{% endif %}sort={{ sort }}"
       class="text-danger text-decoration-none ms-1">&times;</a>
  </span>
  {% endif %}
  {% if selected_category %}
  {% for cat in categories %}{% if cat.pk|stringformat:'s' == selected_category %}
  <span class="filter-pill">
    <i class="bi bi-tag"></i> {{ cat.name }}
    <a href="?{% if query %}q={{ query }}&{% endif %}sort={{ sort }}"
       class="text-danger text-decoration-none ms-1">&times;</a>
  </span>
  {% endif %}{% endfor %}
  {% endif %}
  {% if query or selected_category %}
  <a href="{% url 'book_list' %}" class="text-muted text-decoration-none" style="font-size:.82rem;">
    <i class="bi bi-x-circle me-1"></i>Clear all
  </a>
  {% endif %}
</div>

<!-- BOOKS GRID -->
{% if books %}
<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
  {% for book in books %}
  <div class="col">
    <div class="card h-100 book-card border-0 shadow-sm">

      <!-- Cover -->
      <div class="book-cover-wrap">
        {% if book.cover_image %}
        <img src="{{ book.cover_image.url }}" alt="{{ book.title }}">
        {% else %}
        <div class="book-cover-ph">
          <i class="bi bi-book" style="font-size:4rem;color:#90b4e8;opacity:.6;"></i>
        </div>
        {% endif %}

        <!-- Status ribbon -->
        {% if book.is_available %}
        <span class="status-ribbon ribbon-available">
          <i class="bi bi-check-circle-fill me-1"></i>Available
        </span>
        {% else %}
        <span class="status-ribbon ribbon-unavailable">
          <i class="bi bi-x-circle-fill me-1"></i>Fully Borrowed
        </span>
        {% endif %}
      </div>

      <!-- Body -->
      <div class="card-body d-flex flex-column gap-2">

        <!-- Title -->
        <div class="book-title">
          <a href="{% url 'book_detail' book.pk %}" class="text-decoration-none text-dark">
            {{ book.title }}
          </a>
        </div>

        <!-- Author -->
        <div class="book-author">
          <i class="bi bi-person me-1"></i>{{ book.author|default:"Unknown Author" }}
        </div>

        <!-- Category -->
        {% if book.category %}
        <div>
          <span class="badge" style="background:#e9f0ff;color:#0d47a1;font-size:.74rem;font-weight:600;border-radius:20px;padding:4px 10px;">
            <i class="bi bi-tag me-1"></i>{{ book.category }}
          </span>
        </div>
        {% endif %}

        <!-- Rating stars -->
        <div class="d-flex align-items-center gap-1">
          {% if book.avg_rating %}
          <span class="stars-sm">
            {% for star in book.avg_rating|star_range %}
              {% if star == 'full' %}<i class="bi bi-star-fill"></i>
              {% elif star == 'half' %}<i class="bi bi-star-half"></i>
              {% else %}<i class="bi bi-star" style="color:#dee2e6;"></i>
              {% endif %}
            {% endfor %}
          </span>
          <span style="font-size:.8rem;font-weight:700;color:#856404;">{{ book.avg_rating|floatformat:1 }}</span>
          {% else %}
          <span class="no-rating"><i class="bi bi-star me-1"></i>No ratings yet</span>
          {% endif %}
        </div>

        <!-- View Details button -->
        <div class="mt-auto pt-1">
          <a href="{% url 'book_detail' book.pk %}" class="btn btn-primary btn-details w-100">
            <i class="bi bi-eye me-1"></i>View Details
          </a>
        </div>

      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- PAGINATION -->
{% if books.has_other_pages %}
<nav class="mt-5 d-flex justify-content-center align-items-center gap-3">
  <span class="text-muted" style="font-size:.85rem;">
    Page {{ books.number }} of {{ books.paginator.num_pages }}
  </span>
  <ul class="pagination mb-0">

    <li class="page-item {% if not books.has_previous %}disabled{% endif %}">
      <a class="page-link" href="{% if books.has_previous %}?page=1{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}&sort={{ sort }}{% else %}#{% endif %}">
        <i class="bi bi-chevron-double-left"></i>
      </a>
    </li>
    <li class="page-item {% if not books.has_previous %}disabled{% endif %}">
      <a class="page-link" href="{% if books.has_previous %}?page={{ books.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}&sort={{ sort }}{% else %}#{% endif %}">
        <i class="bi bi-chevron-left"></i>
      </a>
    </li>

    {% for num in books.paginator.page_range %}
      {% if books.number == num %}
      <li class="page-item active"><span class="page-link">{{ num }}</span></li>
      {% elif num >= books.number|add:"-2" and num <= books.number|add:"2" %}
      <li class="page-item">
        <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}&sort={{ sort }}">{{ num }}</a>
      </li>
      {% endif %}
    {% endfor %}

    <li class="page-item {% if not books.has_next %}disabled{% endif %}">
      <a class="page-link" href="{% if books.has_next %}?page={{ books.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}&sort={{ sort }}{% else %}#{% endif %}">
        <i class="bi bi-chevron-right"></i>
      </a>
    </li>
    <li class="page-item {% if not books.has_next %}disabled{% endif %}">
      <a class="page-link" href="{% if books.has_next %}?page={{ books.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}&sort={{ sort }}{% else %}#{% endif %}">
        <i class="bi bi-chevron-double-right"></i>
      </a>
    </li>

  </ul>
</nav>
{% endif %}

{% else %}
<!-- EMPTY STATE -->
<div class="empty-state text-center">
  <i class="bi bi-search" style="font-size:3.5rem;color:#adb5bd;"></i>
  <h4 class="fw-bold mt-3 mb-1">No books found</h4>
  <p class="text-muted mb-4">
    {% if query or selected_category %}
    Try adjusting your search or filters.
    {% else %}
    No books have been added to the library yet.
    {% endif %}
  </p>
  <div class="d-flex gap-2 justify-content-center flex-wrap">
    {% if query or selected_category %}
    <a href="{% url 'book_list' %}" class="btn btn-primary">
      <i class="bi bi-arrow-left me-1"></i>Clear Filters
    </a>
    {% endif %}
    {% if user.is_staff %}
    <a href="{% url 'book_create' %}" class="btn btn-success">
      <i class="bi bi-plus-circle me-1"></i>Add First Book
    </a>
    {% endif %}
  </div>
</div>
{% endif %}

{% endblock %}
