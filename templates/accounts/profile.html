{% extends 'base.html' %}
{% load book_extras %}
{% block title %}My Profile — E-Library{% endblock %}

{% block extra_css %}
<style>
  .profile-hero {
    background: linear-gradient(135deg, #1a237e 0%, #283593 60%, #0d47a1 100%);
    color: #fff;
    padding: 3rem 0 2.5rem;
  }
  .avatar-ring {
    width: 110px; height: 110px; border-radius: 50%;
    border: 4px solid rgba(255,255,255,.4);
    box-shadow: 0 6px 24px rgba(0,0,0,.25);
    object-fit: cover;
  }
  .avatar-placeholder {
    width: 110px; height: 110px; border-radius: 50%;
    border: 4px solid rgba(255,255,255,.4);
    background: rgba(255,255,255,.15);
    display: flex; align-items: center; justify-content: center;
    font-size: 2.8rem; color: #fff;
  }
  .stat-card {
    border-radius: 14px; border: none;
    background: #fff;
    transition: transform .2s, box-shadow .2s;
  }
  .stat-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,.1); }
  .info-row { border-bottom: 1px solid #f0f0f0; padding: .65rem 0; }
  .info-row:last-child { border-bottom: none; }
  .form-control:focus { border-color: #3949ab; box-shadow: 0 0 0 .2rem rgba(57,73,171,.2); }
  .btn-save {
    background: linear-gradient(135deg, #1a237e, #3949ab);
    color: #fff; border: none; border-radius: 10px;
    padding: .6rem 1.8rem; font-weight: 600;
    transition: opacity .2s;
  }
  .btn-save:hover { opacity: .9; color: #fff; }
  #editSection { display: none; }
</style>
{% endblock %}

{% block pre_content %}
<div class="profile-hero">
  <div class="container">
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb mb-0" style="--bs-breadcrumb-divider-color:rgba(255,255,255,.5);">
        <li class="breadcrumb-item">
          <a href="{% url 'home' %}" style="color:rgba(255,255,255,.75);text-decoration:none;">Home</a>
        </li>
        <li class="breadcrumb-item active" style="color:rgba(255,255,255,.9);">My Profile</li>
      </ol>
    </nav>

    <div class="d-flex align-items-center gap-4 flex-wrap">
      {% if user.profile.photo %}
      <img src="{{ user.profile.photo.url }}" class="avatar-ring" alt="{{ user.get_full_name }}">
      {% else %}
      <div class="avatar-placeholder">
        <i class="bi bi-person-fill"></i>
      </div>
      {% endif %}
      <div>
        <p style="opacity:.7;font-size:.82rem;margin-bottom:.2rem;text-transform:uppercase;letter-spacing:1px;">
          {% if user.is_staff %}Administrator{% else %}Student{% endif %}
        </p>
        <h1 style="font-size:1.9rem;font-weight:800;margin-bottom:.4rem;">
          {{ user.get_full_name|default:user.username }}
        </h1>
        <div class="d-flex flex-wrap gap-3" style="font-size:.85rem;opacity:.85;">
          <span><i class="bi bi-at me-1"></i>{{ user.username }}</span>
          <span><i class="bi bi-envelope me-1"></i>{{ user.email }}</span>
          {% if user.profile.phone %}
          <span><i class="bi bi-telephone me-1"></i>{{ user.profile.phone }}</span>
          {% endif %}
          <span><i class="bi bi-calendar3 me-1"></i>Member since {{ user.profile.joined_date|date:"M Y" }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}

<div class="row g-4 mb-4">
  <div class="col-sm-4">
    <div class="stat-card card shadow-sm text-center p-3">
      <div style="width:52px;height:52px;border-radius:14px;background:#e3f0ff;display:inline-flex;align-items:center;justify-content:center;font-size:1.5rem;margin:0 auto .7rem;">
        <i class="bi bi-book-fill" style="color:#1565c0;"></i>
      </div>
      <h3 class="fw-bold mb-0" style="color:#1565c0;">{{ stats.currently_borrowed }}</h3>
      <p class="text-muted small mb-0">Currently Borrowed</p>
    </div>
  </div>
  <div class="col-sm-4">
    <div class="stat-card card shadow-sm text-center p-3">
      <div style="width:52px;height:52px;border-radius:14px;background:#e8f5e9;display:inline-flex;align-items:center;justify-content:center;font-size:1.5rem;margin:0 auto .7rem;">
        <i class="bi bi-check-circle-fill" style="color:#2e7d32;"></i>
      </div>
      <h3 class="fw-bold mb-0" style="color:#2e7d32;">{{ stats.returned }}</h3>
      <p class="text-muted small mb-0">Books Returned</p>
    </div>
  </div>
  <div class="col-sm-4">
    <div class="stat-card card shadow-sm text-center p-3">
      <div style="width:52px;height:52px;border-radius:14px;background:#f3e5f5;display:inline-flex;align-items:center;justify-content:center;font-size:1.5rem;margin:0 auto .7rem;">
        <i class="bi bi-journals" style="color:#6a1b9a;"></i>
      </div>
      <h3 class="fw-bold mb-0" style="color:#6a1b9a;">{{ stats.total_borrowed }}</h3>
      <p class="text-muted small mb-0">Total Borrowed</p>
    </div>
  </div>
</div>

<div class="row g-4 align-items-start">

  <div class="col-lg-4">
    <div class="card border-0 shadow-sm" style="border-radius:14px;">
      <div class="card-body p-4">

        <div id="viewSection">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold mb-0"><i class="bi bi-person me-2 text-primary"></i>Profile Information</h6>
            <a href="{% url 'edit_profile' %}" class="btn btn-outline-primary btn-sm" style="border-radius:8px;">
              <i class="bi bi-pencil me-1"></i>Edit Profile
            </a>
          </div>
          <div class="info-row d-flex justify-content-between gap-2">
            <span class="text-muted small">Full Name</span>
            <span class="fw-semibold small text-end">{{ user.get_full_name|default:"—" }}</span>
          </div>
          <div class="info-row d-flex justify-content-between gap-2">
            <span class="text-muted small">Username</span>
            <span class="fw-semibold small">{{ user.username }}</span>
          </div>
          <div class="info-row d-flex justify-content-between gap-2">
            <span class="text-muted small">Email</span>
            <span class="fw-semibold small text-end" style="word-break:break-all;">{{ user.email|default:"—" }}</span>
          </div>
          <div class="info-row d-flex justify-content-between gap-2">
            <span class="text-muted small">Phone</span>
            <span class="fw-semibold small">{{ user.profile.phone|default:"—" }}</span>
          </div>
          <div class="info-row d-flex justify-content-between gap-2">
            <span class="text-muted small">Member Since</span>
            <span class="fw-semibold small">{{ user.profile.joined_date|date:"M d, Y" }}</span>
          </div>
          <div class="info-row d-flex justify-content-between gap-2">
            <span class="text-muted small">Role</span>
            <span class="badge {% if user.is_staff %}bg-danger{% else %}bg-primary{% endif %}" style="font-size:.72rem;">
              {% if user.is_staff %}Administrator{% else %}Student{% endif %}
            </span>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card border-0 shadow-sm" style="border-radius:14px;overflow:hidden;">
      <div class="card-header bg-white fw-bold py-3 px-4 border-bottom">
        <i class="bi bi-clock-history me-2 text-primary"></i>Borrowing History
        {% if borrow_records %}
        <span class="badge bg-primary ms-2" style="font-size:.72rem;">{{ borrow_records|length }}</span>
        {% endif %}
      </div>
      <div class="card-body p-0">
        {% if borrow_records %}
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th class="px-3" style="font-size:.82rem;">Book</th>
                <th style="font-size:.82rem;">Borrowed</th>
                <th style="font-size:.82rem;">Due Date</th>
                <th style="font-size:.82rem;">Returned</th>
                <th style="font-size:.82rem;">Status</th>
              </tr>
            </thead>
            <tbody>
              {% for record in borrow_records %}
              <tr>
                <td class="px-3">
                  <a href="{% url 'book_detail' record.book.pk %}" class="text-decoration-none fw-semibold text-dark" style="font-size:.88rem;">
                    {{ record.book.title }}
                  </a>
                  {% if record.book.author %}
                  <div class="text-muted" style="font-size:.76rem;">{{ record.book.author.name }}</div>
                  {% endif %}
                </td>
                <td style="font-size:.85rem;">{{ record.borrow_date|date:"M d, Y" }}</td>
                <td style="font-size:.85rem;">
                  {{ record.due_date|date:"M d, Y" }}
                  {% if record.is_overdue %}
                  <br><span class="badge bg-danger" style="font-size:.7rem;">Overdue</span>
                  {% endif %}
                </td>
                <td style="font-size:.85rem;">{{ record.return_date|date:"M d, Y"|default:"—" }}</td>
                <td>
                  {% if record.status == 'borrowed' %}
                  <span class="badge" style="background:#fff3cd;color:#856404;font-size:.72rem;">
                    <i class="bi bi-book me-1"></i>Borrowed
                  </span>
                  {% else %}
                  <span class="badge" style="background:#d1e7dd;color:#0f5132;font-size:.72rem;">
                    <i class="bi bi-check2 me-1"></i>Returned
                  </span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-5">
          <i class="bi bi-inbox" style="font-size:3rem;opacity:.3;"></i>
          <p class="mt-2 mb-1 fw-semibold">No borrowing history yet</p>
          <p class="small mb-3">Start by borrowing a book from the library.</p>
          <a href="{% url 'book_list' %}" class="btn btn-primary btn-sm" style="border-radius:8px;">
            <i class="bi bi-journals me-1"></i>Browse Books
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>
{% endblock %}
